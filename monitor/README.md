## LOG Monitor
Визуализатор метрик лог файла соланы.   
Формирует таблицы значений из лог файла по заданным метрикам для построения графиков.

<details>
<summary>установка</summary>
  
```bash
apt update && apt upgrade && apt install software-properties-common -y
add-apt-repository -y ppa:deadsnakes/ppa
apt install python3.11 python3-pip -y 
```
```bash
mkdir -p $HOME/log_monitor
cd $HOME/log_monitor
curl -o $HOME/log_monitor/log_monitor.py https://raw.githubusercontent.com/Hohlas/solana/main/monitor/log_monitor.py
curl -o $HOME/log_monitor/metrics.txt https://raw.githubusercontent.com/Hohlas/solana/main/monitor/metrics.txt
python3 -m venv myenv # Создать виртуальное окружение
source myenv/bin/activate # Активировать виртуальное окружение
pip install openpyxl

```

![2025-01-16_22-02-21](https://github.com/user-attachments/assets/42648db5-7e15-4220-9284-d02b3ffb62f7)

metrics.txt - Список необходимых метрик. Отредактировать по необходимости.  
metrics.xlsx - Полученный файл с таблицами для построения графиков.

</details>


```bash
# копирование заданного временного отрезка лог файла
awk '/T12:00:00/,/T13:00:00/' ~/solana/solana.log > ~/log_monitor/solana.log
```
```bash
# Запуск log_monitor.py для создания файла с таблицами metrics.xlsx
cd $HOME/log_monitor
source myenv/bin/activate # Активировать виртуальное окружение
python3 $HOME/log_monitor/log_monitor.py
```
<details>
<summary>описание метрик</summary>

- num_errors_cross_beam_recv_timeout - ошибки при получении данных через cross-beam каналы.
    
     Ненулевые значения указывают на проблемы с получением данных из сети (сервер часто теряет соединение), или потерей пакетов. Связаны с сетевыми и консенсусными операциями, их точное значение требует изучения исходного кода
    
- num_errors_other - Общее количество других ошибок,
    
    которые могут возникать при обработке данных. Это может включать сетевые ошибки.
    
- replay_total_elapsed - время на обработку и повторное воспроизведение блоков для подтверждения.
    
    Вероятно, общее время, затраченное на воспроизведение реестра (ledger replay) для синхронизации с текущим состоянием блокчейна.
    
    Увеличение может указывать на проблемы с производительностью. Связаны с сетевыми и консенсусными операциями, но их точное значение требует изучения исходного кода
    
- num_errors_blockstore - Ошибки, связанные с хранилищем блоков,
    
    могут указывать на проблемы с доступом к данным,  с дисковой подсистемой.
    
- num_packets_received / num_packets_sent - количество полученных/отправленных пакетов,
    
     включая транзакции и сообщения Gossip. Это метрика сетевой активности, показывающая нагрузку на сетевой интерфейс. Низкие значения могут указывать на проблемы с сетевым соединением.
    
- process_gossip_packets_time - Время на обработку gossip-пакетов.
    
    Gossip протокол используется для распространения информации о состоянии сети между валидаторами. Высокие значения могут указывать на задержки в сети
    
- gossip_transmit_loop_time - Время на передачу сообщений "госипа"
    
    Высокие значения говорят о проблемах с интернет-соединением.
    
- fetch_stage_packets_forwarded - Количество пакетов, переданных на стадии получения.
    
    Fetch stage отвечает за получение и первичную обработку пакетов транзакций. Низкие значения могут сигнализировать о проблемах с сетью или перегрузкой узла.
    
- total_elapsed_us - Общее время выполнения операций в микросекундах.
    
     Если это время значительно увеличивается, это может быть признаком проблем с сетью или производительностью.
    
- average_load_one_minute - загрузка CPU за минуту (load average)
- validator-duplicate-confirmation duration_ms - Время на обработку дублирующихся подтверждений. Это часть механизма консенсуса Solana.
- fork_weight - Вес форка (альтернативной цепочки блоков), приоритет конкретной ветви в случае форка сети
    
    вероятно, связанный с долей стейка или другим показателем, используемым для выбора канонической цепи
    
- bank-forks_set_root elapsed_ms - Время на установку корня в структуре bank-forks, что связано с финализацией блоков
    
    Bank-forks - это структура данных, представляющая различные состояния блокчейна.
    
- block-commitment-cache aggregate-commitment-ms - Время агрегации подтверждений блоков в кэше
    
    , важное для подтверждения блоков.
    
- replay-loop-voting-stats generate_vote_us - Время генерации голоса в цикле воспроизведения
    
    , часть участия в консенсусе. Это критически важная метрика для процесса голосования валидатора.
    
- replay-loop-timing-stats loop_count - Количество итераций цикла воспроизведения.
    
    Показывает активность процесса воспроизведения блоков. 
    
- vote_txn_processing_us - Время обработки транзакций голосования, необходимых для участия в консенсусе.
- slot_confirming_time_us - Время подтверждения слота (блока), важное для оценки скорости консенсуса.
    
    Слот - это временной интервал, в течение которого лидер создает блок.
    
- writes_completed - Количество завершенных операций записи на диск.
    
    Это метрика производительности дисковой подсистемы.
    
- writes_merged - Количество объединенных операций записи.
    
    Операции записи могут быть объединены для повышения эффективности дисковой подсистемы.
    

---

- tower_observed_root_diff = [ tower-observed ] - [ root ]
    
    tower-observed - последний слот, который валидатор наблюдал и учитывает в своем tower. Он отражает прогресс сети с точки зрения валидатора.
    root - корневой подтвержденный слот, определяется консенсусом сети.
    
    **Разница между ними** показывает, насколько "свежие" данные видит валидатор по сравнению с закрепленным состоянием сети
    
    Большая положительная разница означает, что валидатор видит много новых слотов после последнего закрепленного корня. Это может быть нормально в процессе синхронизации, при высокой активности сети, но слишком большие значения могут указывать на задержки в финализации. Отрицательное значение указывало бы на серьезную проблему
    
- tower_vote_root_diff - [ tower-vote latest ] - [ root ]
    
    tower-vote latest - последний слот, за который проголосовал валидатор
    
    root - корневой слот
    
    **Разница между ними** показывает, насколько "вперед" голосует валидатор по сравнению с закрепленным корнем
    
    Это важный показатель активности валидатора. Если разница слишком маленькая, валидатор может отставать в голосовании. Если слишком большая - может голосовать за слоты, которые еще не имеют достаточного подтверждения от сети.
    
- slot_is_dead - отмечает, является ли слот, за который проголосовал валидатор, "мертвым”
    
    Слот помечается как "мертвый", когда он больше не является частью основной цепи, это происходит в результате форка, когда одна из ветвей становится неактуальной.
    
    Большое количество мертвых слотов указывает на то, что валидатор часто забегает вперед, нужно перенастроить патч.
    
- fork_to_replay_time - Время [ replay-slot-stats ] - [ fork_time ]
    
    replay-slot-stats - Начало процесса воспроизведения (replay) транзакций для слота в форке 
    fork_time - Момент, когда валидатор обнаруживает новый форк
    
    - Показывает, сколько времени проходит от обнаружения нового форка до начала его обработки
    - Чем меньше это время, тем быстрее валидатор реагирует на изменения в сети
    - Длительные задержки могут указывать на проблемы с производительностью валидатора или высокую нагрузку
    
    Эта метрика помогает оценить эффективность первого этапа обработки новых данных в блокчейне.
    
- replay_to_vote_time - Время [ vote_time ] - [ replay-slot-stats ]
    
    vote_time - последние голоса валидатора
    replay-slot-stats - процесс воспроизведения (replay) транзакций в конкретном слоте  
    
    Показывает, сколько времени требуется валидатору для проверки и голосования после воспроизведения транзакций. Измеряет временной интервал между:
    
    1. Моментом, когда валидатор завершил воспроизведение (replay) транзакций в слоте
    2. Моментом, когда валидатор проголосовал за этот слот (`tower-vote latest` событие)

</details>

<details>
<summary>последовательность обработки слота в Solana</summary>

- 
    1. **Новый форк**: `new fork:322812148 parent:322812147 root:322812116`
        - Нода обнаруживает новый слот и создаёт для него форк
    2. **Создание банка**: `bank-new_from_parent-heights slot=322812148i`
        - Создаётся новый банк на основе родительского
    3. **Получение шардов**: `shred_fetch`
        - Продолжается получение шардов из сети
    4. **Завершение сбора шардов**: `shred_insert_is_full slot=322812148i`
        - Все необходимые шарды для слота получены
    5. **Обработка слота завершена**: `replay-slot-stats slot=322812148i`
        - Завершение воспроизведения транзакций и подготовка статистики слота
    
    Для мониторинга отставания от сети стоит обратить внимание на временную разницу между этими событиями. Если между обнаружением нового форка (`new fork`) и завершением обработки (`replay-slot-stats`) проходит слишком много времени, это может указывать на проблемы с производительностью ноды.
    
    Также полезно отслеживать, как быстро обновляется метрика `tower-vote latest` после появления метрики `replay-slot-stats` для того же слота. Это покажет, насколько быстро нода может голосовать после получения и обработки слота.

</details>

В терминале появится вывод статистики выбросов по слотам  

![image](https://github.com/user-attachments/assets/c1735afd-bc05-438a-bc36-4450804c5692)

Открыть в екселе metrics.xlsx

![image](https://github.com/user-attachments/assets/4e553fb8-e21e-435a-8e5d-4026574f60aa)



## TVC scanner

```bash
mkdir -p $HOME/tvc_scan
cd $HOME/tvc_scan
curl -o $HOME/tvc_scan/tvc.sh https://raw.githubusercontent.com/Hohlas/solana/main/monitor/tvc.sh
curl -o $HOME/tvc_scan/validators.txt https://raw.githubusercontent.com/Hohlas/solana/main/monitor/validators.txt
chmod +x $HOME/tvc_scan/tvc.sh
./tvc.sh
```
